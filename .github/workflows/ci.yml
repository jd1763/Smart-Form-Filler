name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
      NLTK_DATA: ${{ github.workspace }}/.nltk_data


    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"   # match local version
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            backend/requirements.txt

      - name: Show versions
        run: |
          python --version
          pip --version

      - name: Preinstall CPU-only PyTorch
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu torch==2.2.2


      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install -r backend/requirements.txt || true
          pip install pytest flake8


      - name: Download NLTK data
        run: |
          python - <<'PY'
          import nltk, os
          pkgs = ["punkt","punkt_tab","averaged_perceptron_tagger","averaged_perceptron_tagger_eng","stopwords","wordnet","omw-1.4"]
          for p in pkgs:
              nltk.download(p, download_dir=os.environ["NLTK_DATA"], quiet=True)
          print("NLTK downloaded to:", os.environ["NLTK_DATA"])
          PY

      - name: Show tool versions
        run: |
          pytest --version
          flake8 --version

      # === Run tests ===
      - name: Run tests
        run: pytest -vv --maxfail=1

      # === Lint check ===
      - name: Run flake8
        run: flake8 .